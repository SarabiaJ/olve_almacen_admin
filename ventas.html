<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Ventas</title>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body style="background-color:#3D4A4B; color:white;">

    <header class="text-center py-4">
        <h1 style="color:#e7c158;">Administración de Ventas</h1>
        <a href="index.html" class="btn btn-warning mt-2">
            <i class="bi bi-arrow-left-circle"></i> Volver al Panel
        </a>
    </header>

    <main class="container mt-4">

        <div class="text-end mb-3">
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAgregar">
                <i class="bi bi-plus"></i> Registrar Venta
            </button>
        </div>

        <!-- TABLA -->
        <div class="table-responsive">
            <table class="table table-dark table-striped table-bordered align-middle text-center">
                <thead style="background-color:#2b2b2b; color:#e7c158;">
                    <tr>
                        <th>ID Venta</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Método de Pago</th>
                        <th>ID Cliente</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody id="tablaVentas"></tbody>
            </table>
        </div>

    </main>

    <!-- MODAL AGREGAR -->
    <div class="modal fade" id="modalAgregar" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background:#3D4A4B; color:white;">

                <div class="modal-header">
                    <h5 class="modal-title" style="color:#e7c158;">Registrar Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label>Fecha:</label>
                            <input type="date" id="add-fecha" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label>Total:</label>
                            <input type="number" step="0.01" id="add-total" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label>Método de Pago:</label>
                            <select id="add-metodopago" class="form-control">
                                <option>Efectivo</option>
                                <option>Tarjeta</option>
                                <option>Transferencia</option>
                                <option>Nequi / Daviplata</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label>ID Cliente:</label>
                            <input type="number" id="add-idcliente" class="form-control">
                        </div>

                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" onclick="agregarVenta()">Guardar</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL EDITAR -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background:#3D4A4B; color:white;">

                <div class="modal-header">
                    <h5 class="modal-title" style="color:#e7c158;">Editar Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <div class="row g-3">

                        <div class="col-md-4">
                            <label>ID Venta:</label>
                            <input type="number" id="edit-id" class="form-control" readonly>
                        </div>

                        <div class="col-md-4">
                            <label>Fecha:</label>
                            <input type="date" id="edit-fecha" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label>Total:</label>
                            <input type="number" step="0.01" id="edit-total" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label>Método de Pago:</label>
                            <select id="edit-metodopago" class="form-control">
                                <option>Efectivo</option>
                                <option>Tarjeta</option>
                                <option>Transferencia</option>
                                <option>Nequi / Daviplata</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label>ID Cliente:</label>
                            <input type="number" id="edit-idcliente" class="form-control">
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-warning" onclick="actualizarVenta()">Actualizar</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        const API_URL = "https://olve-almacen-admin-backend.onrender.com/api/ventas";

        /* ============================
             LISTAR
        ============================ */
        async function cargarVentas() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();

                const tabla = document.getElementById("tablaVentas");
                tabla.innerHTML = "";

                data.forEach(v => {
                    tabla.innerHTML += `
                        <tr>
                            <td>${v.idVenta}</td>
                            <td>${v.fecha}</td>
                            <td>$${v.total}</td>
                            <td>${v.metodoPago}</td>
                            <td>${v.idCliente}</td>
                            <td>
                                <button class="btn btn-warning btn-sm"
                                    onclick="abrirModalEditar(${v.idVenta}, '${v.fecha}', ${v.total}, '${v.metodoPago}', ${v.idCliente})">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-sm"
                                    onclick="eliminarVenta(${v.idVenta})">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (err) {
                console.error(err);
            }
        }

        /* ============================
             AGREGAR
        ============================ */
        async function agregarVenta() {

            const venta = {
                fecha: document.getElementById("add-fecha").value,
                total: parseFloat(document.getElementById("add-total").value),
                metodoPago: document.getElementById("add-metodopago").value,
                idCliente: parseInt(document.getElementById("add-idcliente").value)
            };

            await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(venta)
            });

            bootstrap.Modal.getInstance(document.getElementById("modalAgregar")).hide();
            cargarVentas();
        }

        /* ============================
             ABRIR EDITAR
        ============================ */
        function abrirModalEditar(id, fecha, total, metodoPago, idCliente) {

            document.getElementById("edit-id").value = id;
            document.getElementById("edit-fecha").value = fecha;
            document.getElementById("edit-total").value = total;
            document.getElementById("edit-metodopago").value = metodoPago;
            document.getElementById("edit-idcliente").value = idCliente;

            new bootstrap.Modal(document.getElementById("modalEditar")).show();
        }

        /* ============================
             ACTUALIZAR
        ============================ */
        async function actualizarVenta() {

            const venta = {
                idVenta: parseInt(document.getElementById("edit-id").value),
                fecha: document.getElementById("edit-fecha").value,
                total: parseFloat(document.getElementById("edit-total").value),
                metodoPago: document.getElementById("edit-metodopago").value,
                idCliente: parseInt(document.getElementById("edit-idcliente").value)
            };

            await fetch(API_URL, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(venta)
            });

            bootstrap.Modal.getInstance(document.getElementById("modalEditar")).hide();
            cargarVentas();
        }

        /* ============================
             ELIMINAR
        ============================ */
        async function eliminarVenta(id) {
            if (!confirm("¿Eliminar venta?")) return;

            await fetch(API_URL + "/" + id, { method: "DELETE" });

            cargarVentas();
        }

        cargarVentas();
    </script>

</body>

</html>